name: Backend CI/CD

on:
  push:
    branches: ["main"]
  pull_request:
    branches: ["main"]

permissions:
  contents: read
  pages: write
  id-token: write

concurrency:
  group: "pages"
  cancel-in-progress: false

env:
  NODE_VERSION: "20.x"

jobs:
  # Build and test all microservices
  build-services:
    runs-on: ubuntu-latest

    strategy:
      matrix:
        service:
          - common
          - api-gateway
          - auth-service
          - user-service
          - recipe-service
          - chat-service
          - notification-service
          - websocket-service
      fail-fast: false

    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: "npm"
          cache-dependency-path: backend/package-lock.json

      - name: Install root dependencies
        run: npm ci
        working-directory: backend

      - name: Build common module first (dependency for all services)
        if: matrix.service != 'common'
        run: npm run build --workspace=common
        working-directory: backend

      - name: Generate Prisma client (if applicable)
        if: matrix.service != 'common' && matrix.service != 'api-gateway' && matrix.service != 'websocket-service'
        run: |
          if [ -f "backend/${{ matrix.service }}/prisma/schema.prisma" ]; then
            cd backend/${{ matrix.service }}
            npx prisma generate
          fi
        continue-on-error: true

      - name: Build ${{ matrix.service }}
        run: npm run build --workspace=${{ matrix.service }}
        working-directory: backend

  # Deploy API documentation to GitHub Pages
  deploy-docs:
    runs-on: ubuntu-latest
    needs: build-services
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'

    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}

    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: "npm"
          cache-dependency-path: backend/package-lock.json

      - name: Install dependencies
        run: npm ci
        working-directory: backend

      - name: Build common module
        run: npm run build --workspace=common
        working-directory: backend

      - name: Setup PostgreSQL
        uses: ikalnytskyi/action-setup-postgres@v6
        with:
          username: postgres
          password: postgres
          database: ft_transcendence
          port: 5432
        id: postgres

      - name: Install Redoc CLI
        run: npm install -g @redocly/cli

      - name: Create documentation directory
        run: mkdir -p public/documentation/api-docs

      - name: Start API Gateway and fetch OpenAPI spec
        run: |
          cd backend/api-gateway

          # Database
          export DATABASE_URL="${{ steps.postgres.outputs.connection-uri }}"
          export AUTH_DATABASE_URL="$DATABASE_URL"
          export RECIPE_DATABASE_URL="$DATABASE_URL"
          export USER_DATABASE_URL="$DATABASE_URL"
          export NOTIFICATION_DATABASE_URL="$DATABASE_URL"
          export CHAT_DATABASE_URL="$DATABASE_URL"

          # Secrets
          export API_GATEWAY_KEY="github-actions-doc-generation"
          export API_MASTER_SECRET="github-actions-master-secret"
          export API_KEY_MAX_AGE_SECONDS=31536000
          export INTERNAL_API_KEY="github-actions-internal-key"
          export JWT_SECRET="github-actions-jwt-secret"
          export COOKIE_SECRET="github-actions-cookie-secret"
          export RESEND_API_KEY="github-actions-resend-key"
          export MAILBOX_KEY="github-actions-mailbox-key"
          export MAILBOX_ADDRESS="cookshare@cookshare.me"

          # Ports
          export API_GATEWAY_PORT=3000
          export RECIPE_SERVICE_PORT=3001
          export AUTH_SERVICE_PORT=3002
          export USER_SERVICE_PORT=3003
          export CHAT_SERVICE_PORT=3004
          export NOTIFICATION_SERVICE_PORT=3005

          # Domain & URLs
          export DOMAIN="localhost"
          export API_GATEWAY_URL="http://${DOMAIN}:${API_GATEWAY_PORT}"
          export RECIPE_SERVICE_URL="http://${DOMAIN}:${RECIPE_SERVICE_PORT}"
          export AUTH_SERVICE_URL="http://${DOMAIN}:${AUTH_SERVICE_PORT}"
          export USER_SERVICE_URL="http://${DOMAIN}:${USER_SERVICE_PORT}"
          export CHAT_SERVICE_URL="http://${DOMAIN}:${CHAT_SERVICE_PORT}"
          export NOTIFICATION_SERVICE_URL="http://${DOMAIN}:${NOTIFICATION_SERVICE_PORT}"

          # Other
          export STAGE="development"
          export DEBUG="true"
          export DOMAIN_NAME="localhost"

          npx prisma migrate deploy || npx prisma db push || true

          npm run dev > /tmp/api-gateway.log 2>&1 &
          SERVER_PID=$!

          echo "Waiting for API Gateway to start..."
          for i in {1..60}; do
            if curl -s http://127.0.0.1:3000/documentation > /dev/null 2>&1; then
              echo "API Gateway is ready!"
              break
            fi
            if [ $i -eq 60 ]; then
              echo "Timeout waiting for API Gateway"
              cat /tmp/api-gateway.log
              kill $SERVER_PID 2>/dev/null || true
              exit 1
            fi
            echo "Waiting... ($i/60)"
            sleep 1
          done

          # Fetch the actual OpenAPI spec from the correct endpoint
          # Fastify-swagger default is {routePrefix}/json
          curl -s http://127.0.0.1:3000/documentation/json -o ../../openapi-spec.json

          # Check if we got an error message instead of the spec
          if grep -q "Route GET" ../../openapi-spec.json || grep -q "Not Found" ../../openapi-spec.json; then
            echo "Failed to fetch spec from /documentation/json, trying /api/v1/json..."
            curl -s http://127.0.0.1:3000/api/v1/json -o ../../openapi-spec.json
          fi

          kill $SERVER_PID 2>/dev/null || true

      - name: Generate Swagger UI page
        run: |
          cp openapi-spec.json public/documentation/openapi-spec.json

          cat > public/documentation/index.html << 'EOF'
          <!DOCTYPE html>
          <html lang="en">
          <head>
            <meta charset="UTF-8">
            <title>CookShare API - Swagger UI</title>
            <link rel="stylesheet" href="https://unpkg.com/swagger-ui-dist@5.11.0/swagger-ui.css" />
            <style>
              body { margin: 0; padding: 0; }
              .topbar { display: none; }
            </style>
          </head>
          <body>
            <div id="swagger-ui"></div>
            <script src="https://unpkg.com/swagger-ui-dist@5.11.0/swagger-ui-bundle.js"></script>
            <script src="https://unpkg.com/swagger-ui-dist@5.11.0/swagger-ui-standalone-preset.js"></script>
            <script>
              window.onload = () => {
                SwaggerUIBundle({
                  url: "./openapi-spec.json",
                  dom_id: '#swagger-ui',
                  presets: [SwaggerUIBundle.presets.apis, SwaggerUIStandalonePreset],
                  layout: "StandaloneLayout"
                });
              };
            </script>
          </body>
          </html>
          EOF

      - name: Generate Redoc documentation
        run: |
          if [ -f openapi-spec.json ]; then
            npx @redocly/cli build-docs openapi-spec.json -o public/api-reference.html
          fi
        continue-on-error: true

      - name: Copy static HTML API documentation
        run: |
          if [ -d "docs/api/API Documentation/HTML format" ]; then
            cp -r "docs/api/API Documentation/HTML format/"* public/documentation/api-docs/
            
            cat > public/documentation/api-docs/index.html << 'EOF'
          <!DOCTYPE html>
          <html lang="fr">
          <head>
            <meta charset="UTF-8">
            <meta name="viewport" content="width=device-width, initial-scale=1.0">
            <title>Documentation API - CookShare</title>
            <style>
              body { font-family: system-ui, sans-serif; max-width: 900px; margin: 50px auto; padding: 20px; background: #f5f5f5; }
              h1 { color: #333; text-align: center; }
              .grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 1rem; }
              .card { background: white; padding: 1.5rem; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
              .card:hover { transform: translateY(-2px); box-shadow: 0 4px 8px rgba(0,0,0,0.15); }
              .card a { color: #2563eb; text-decoration: none; font-weight: 500; }
              .back { text-align: center; margin-bottom: 2rem; }
              .back a { color: #666; }
            </style>
          </head>
          <body>
            <div class="back"><a href="../">‚Üê Swagger UI</a> | <a href="../../">‚Üê Accueil</a></div>
            <h1>Documentation API CookShare</h1>
            <div class="grid">
              <div class="card"><a href="user-documentation.html">üë• Utilisateurs</a></div>
              <div class="card"><a href="recipe-documentation.html">üçΩÔ∏è Recettes</a></div>
              <div class="card"><a href="category-documentation.html">üìÅ Cat√©gories</a></div>
              <div class="card"><a href="search recipe-documentation.html">üîç Recherche</a></div>
              <div class="card"><a href="favorite recipe-documentation.html">‚ù§Ô∏è Favoris</a></div>
              <div class="card"><a href="rate recipe-documentation.html">‚≠ê Notes</a></div>
              <div class="card"><a href="comment recipe-documentation.html">üí¨ Commentaires</a></div>
              <div class="card"><a href="public api key-documentation.html">üîë Cl√©s API</a></div>
              <div class="card"><a href="image-documentation.html">üñºÔ∏è Images</a></div>
            </div>
          </body>
          </html>
          EOF
          fi

      - name: Copy markdown documentation
        run: cp -r docs/api/*.md public/ 2>/dev/null || true

      - name: Create index page
        run: |
          cat > public/index.html << 'EOF'
          <!DOCTYPE html>
          <html lang="fr">
          <head>
            <meta charset="UTF-8">
            <meta name="viewport" content="width=device-width, initial-scale=1.0">
            <title>CookShare - Documentation API</title>
            <style>
              body { font-family: system-ui, sans-serif; max-width: 1200px; margin: 0 auto; padding: 2rem; background: #f5f5f5; }
              header { background: white; padding: 2rem; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); margin-bottom: 2rem; }
              h1 { color: #333; margin: 0 0 0.5rem 0; }
              .subtitle { color: #666; }
              .cards { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 1.5rem; }
              .card { background: white; padding: 1.5rem; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); transition: transform 0.2s; }
              .card:hover { transform: translateY(-2px); box-shadow: 0 4px 8px rgba(0,0,0,0.15); }
              .card h2 { margin-top: 0; color: #2563eb; }
              .card p { color: #666; margin-bottom: 1rem; }
              .card a { display: inline-block; padding: 0.5rem 1rem; background: #2563eb; color: white; text-decoration: none; border-radius: 4px; }
              .card a:hover { background: #1d4ed8; }
              footer { margin-top: 3rem; padding-top: 2rem; border-top: 1px solid #ddd; text-align: center; color: #666; }
            </style>
          </head>
          <body>
            <header>
              <h1>üç≥ CookShare API Documentation</h1>
              <p class="subtitle">Documentation compl√®te des APIs du projet</p>
            </header>
            <div class="cards">
              <div class="card">
                <h2>üìÑ Documentation Statique</h2>
                <p>Pages HTML d√©taill√©es pour chaque endpoint de l'API.</p>
                <a href="documentation/api-docs/">Voir la documentation</a>
              </div>
              <div class="card">
                <h2>üöÄ Swagger UI</h2>
                <p>Interface interactive pour tester les endpoints directement.</p>
                <a href="documentation/">Acc√©der √† Swagger UI</a>
              </div>
              <div class="card">
                <h2>üìö R√©f√©rence API</h2>
                <p>Documentation Redocly avec tous les sch√©mas et exemples.</p>
                <a href="api-reference.html">Voir la r√©f√©rence</a>
              </div>
            </div>
            <footer>
              <p>CookShare - <a href="https://cookshare.me">cookshare.me</a></p>
            </footer>
          </body>
          </html>
          EOF

      - name: Copy CNAME file
        run: |
          if [ -f CNAME ]; then
            cp CNAME public/CNAME
          fi

      - name: Setup Pages
        uses: actions/configure-pages@v4

      - name: Upload artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: "./public"
          name: backend-docs

      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4
        with:
          artifact_name: backend-docs
