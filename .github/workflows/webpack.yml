name: NodeJS with Webpack

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]

# Sets permissions of the GITHUB_TOKEN to allow deployment to GitHub Pages
permissions:
  contents: read
  pages: write
  id-token: write

# Allow only one concurrent deployment, skipping runs queued between the run in-progress and latest queued.
# However, do NOT cancel in-progress runs as we want to allow these production deployments to complete.
concurrency:
  group: "pages"
  cancel-in-progress: false

jobs:
  build:
    runs-on: ubuntu-latest

    strategy:
      matrix:
        node-version: [18.x, 20.x, 22.x]

    steps:
    - uses: actions/checkout@v4

    - name: Use Node.js ${{ matrix.node-version }}
      uses: actions/setup-node@v4
      with:
        node-version: ${{ matrix.node-version }}

    - name: Build
      run: |
        npm install
        npx webpack
      continue-on-error: true

  # Build and deploy API documentation
  build-docs:
    runs-on: ubuntu-latest
    # Only run this job on the main branch (to avoid duplicate deployments)
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    
    steps:
    - uses: actions/checkout@v4

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20.x'

    - name: Install Redoc CLI
      run: npm install -g @redocly/cli

    - name: Create documentation directory
      run: mkdir -p public

    - name: Generate API documentation from OpenAPI spec
      run: |
        npx @redocly/cli build-docs docs/api/apiGateway.json -o public/api-reference.html

    - name: Copy markdown documentation
      run: |
        cp -r docs/api/*.md public/ || true

    - name: Create index page
      run: |
        cat > public/index.html << 'EOF'
        <!DOCTYPE html>
        <html lang="fr">
        <head>
            <meta charset="UTF-8">
            <meta name="viewport" content="width=device-width, initial-scale=1.0">
            <title>Transcendence - Documentation API</title>
            <style>
                body {
                    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
                    line-height: 1.6;
                    max-width: 1200px;
                    margin: 0 auto;
                    padding: 2rem;
                    background: #f5f5f5;
                }
                header {
                    background: white;
                    padding: 2rem;
                    border-radius: 8px;
                    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
                    margin-bottom: 2rem;
                }
                h1 {
                    color: #333;
                    margin: 0 0 0.5rem 0;
                }
                .subtitle {
                    color: #666;
                    font-size: 1.1rem;
                }
                .cards {
                    display: grid;
                    grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
                    gap: 1.5rem;
                }
                .card {
                    background: white;
                    padding: 1.5rem;
                    border-radius: 8px;
                    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
                    transition: transform 0.2s, box-shadow 0.2s;
                }
                .card:hover {
                    transform: translateY(-2px);
                    box-shadow: 0 4px 8px rgba(0,0,0,0.15);
                }
                .card h2 {
                    margin-top: 0;
                    color: #2563eb;
                }
                .card p {
                    color: #666;
                    margin-bottom: 1rem;
                }
                .card a {
                    display: inline-block;
                    padding: 0.5rem 1rem;
                    background: #2563eb;
                    color: white;
                    text-decoration: none;
                    border-radius: 4px;
                    transition: background 0.2s;
                }
                .card a:hover {
                    background: #1d4ed8;
                }
                footer {
                    margin-top: 3rem;
                    padding-top: 2rem;
                    border-top: 1px solid #ddd;
                    text-align: center;
                    color: #666;
                }
            </style>
        </head>
        <body>
            <header>
                <h1>Documentation API Transcendence</h1>
                <p class="subtitle">Documentation compl√®te des APIs du projet Transcendence</p>
            </header>

            <div class="cards">
                <div class="card">
                    <h2>üìö R√©f√©rence API</h2>
                    <p>Documentation interactive de l'API Gateway avec tous les endpoints, sch√©mas et exemples de requ√™tes.</p>
                    <a href="api-reference.html">Voir la r√©f√©rence</a>
                </div>

                <div class="card">
                    <h2>üìñ Guide API</h2>
                    <p>Introduction aux concepts des APIs et guide d'utilisation pour les d√©veloppeurs.</p>
                    <a href="api.md">Lire le guide</a>
                </div>

                <div class="card">
                    <h2>üîê Authentification</h2>
                    <p>Documentation sur les m√©thodes d'authentification et la gestion des utilisateurs.</p>
                    <a href="auth.md">Documentation auth</a>
                </div>

                <div class="card">
                    <h2>üí¨ Chat Service</h2>
                    <p>Documentation de l'API de messagerie et chat en temps r√©el.</p>
                    <a href="chat.md">Documentation chat</a>
                </div>

                <div class="card">
                    <h2>üë• Utilisateurs</h2>
                    <p>Gestion des profils utilisateurs et des donn√©es associ√©es.</p>
                    <a href="users.md">Documentation utilisateurs</a>
                </div>

                <div class="card">
                    <h2>üç≥ Recettes</h2>
                    <p>API de gestion des recettes, ingr√©dients et instructions.</p>
                    <a href="recipes.md">Documentation recettes</a>
                </div>

                <div class="card">
                    <h2>üîî Notifications</h2>
                    <p>Syst√®me de notifications et alertes en temps r√©el.</p>
                    <a href="notifications.md">Documentation notifications</a>
                </div>
            </div>

            <footer>
                <p>Projet Transcendence - <a href="https://cookshare.me" target="_blank">cookshare.me</a></p>
            </footer>
        </body>
        </html>
        EOF

    - name: Copy CNAME file
      run: cp CNAME public/CNAME

    - name: Setup Pages
      uses: actions/configure-pages@v4

    - name: Upload artifact
      uses: actions/upload-pages-artifact@v3
      with:
        path: './public'

    - name: Deploy to GitHub Pages
      id: deployment
      uses: actions/deploy-pages@v4
