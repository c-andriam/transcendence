// generator client {
//   provider = "prisma-client-js"
// }

// datasource db {
//   provider = "postgresql"
// }

// model Recipe {
//   id          Int      @id @default(autoincrement())
//   title       String
//   ingredients String
//   description String?
//   createdAt   DateTime @default(now())
// }

// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

// ==================== UTILISATEURS ====================

model User {
  id         String    @id @default(cuid())
  email      String    @unique
  username   String    @unique
  password   String
  firstName  String?
  lastName   String?
  bio        String?
  avatarUrl  String?   @default("/default-avatar.png")
  isOnline   Boolean   @default(false)
  lastSeenAt DateTime?
  createdAt  DateTime  @default(now())
  updatedAt  DateTime  @updatedAt

  recipes                Recipe[]
  followers              Follow[]                  @relation("Following")
  following              Follow[]                  @relation("Followers")
  ratings                Rating[]
  comments               Comment[]
  favorites              Favorite[]
  sentMessages           Message[]                 @relation("SentMessages")
  conversations          ConversationParticipant[]
  notifications          Notification[]
  friendRequestsSent     FriendRequest[]           @relation("FriendRequestSent")
  friendRequestsReceived FriendRequest[]           @relation("FriendRequestReceived")

  @@index([email])
  @@index([username])
}

// ==================== SYSTÈME D'AMIS ====================

model FriendRequest {
  id        String              @id @default(cuid())
  status    FriendRequestStatus @default(PENDING)
  createdAt DateTime            @default(now())
  updatedAt DateTime            @updatedAt

  senderId String
  sender   User   @relation("FriendRequestSent", fields: [senderId], references: [id], onDelete: Cascade)

  receiverId String
  receiver   User   @relation("FriendRequestReceived", fields: [receiverId], references: [id], onDelete: Cascade)

  @@unique([senderId, receiverId])
  @@index([senderId])
  @@index([receiverId])
}

enum FriendRequestStatus {
  PENDING
  ACCEPTED
  REJECTED
}

model Follow {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now())

  followerId String
  follower   User   @relation("Followers", fields: [followerId], references: [id], onDelete: Cascade)

  followingId String
  following   User   @relation("Following", fields: [followingId], references: [id], onDelete: Cascade)

  @@unique([followerId, followingId])
  @@index([followerId])
  @@index([followingId])
}

// ==================== RECETTES ====================

model Recipe {
  id          String     @id @default(cuid())
  title       String
  slug        String     @unique
  description String
  prepTime    Int // minutes
  cookTime    Int // minutes
  servings    Int
  difficulty  Difficulty @default(MEDIUM)
  isPublished Boolean    @default(false)
  viewCount   Int        @default(0)
  createdAt   DateTime   @default(now())
  updatedAt   DateTime   @updatedAt

  authorId String
  author   User   @relation(fields: [authorId], references: [id], onDelete: Cascade)

  categoryId String
  category   Category @relation(fields: [categoryId], references: [id])

  ingredients  RecipeIngredient[]
  instructions Instruction[]
  images       RecipeImage[]
  ratings      Rating[]
  comments     Comment[]
  favorites    Favorite[]
  dietaryTags  RecipeDietaryTag[]

  @@index([authorId])
  @@index([categoryId])
  @@index([isPublished])
  @@index([createdAt])
  @@index([viewCount])
}

enum Difficulty {
  EASY // Facile
  MEDIUM // Moyen
  HARD // Difficile
}

model Category {
  id        String  @id @default(cuid())
  name      String  @unique // Plats, Entrées, Desserts, Boissons... 
  slug      String  @unique
  iconName  String?
  color     String?
  sortOrder Int     @default(0)

  recipes Recipe[]

  @@index([slug])
}

// ==================== INGRÉDIENTS ====================

model RecipeIngredient {
  id           String  @id @default(cuid())
  name         String // "Poulet", "Crème fraîche", "Épices tikka"
  quantityText String // "500g", "200ml", "2 c.s" - correspond à votre UI
  sortOrder    Int     @default(0)
  isOptional   Boolean @default(false)

  recipeId String
  recipe   Recipe @relation(fields: [recipeId], references: [id], onDelete: Cascade)

  @@index([recipeId])
}

// ==================== INSTRUCTIONS ====================

model Instruction {
  id          String @id @default(cuid())
  stepNumber  Int // 1, 2, 3... 
  description String // Texte de l'étape

  recipeId String
  recipe   Recipe @relation(fields: [recipeId], references: [id], onDelete: Cascade)

  @@unique([recipeId, stepNumber])
  @@index([recipeId])
}

// ==================== IMAGES ====================

model RecipeImage {
  id        String  @id @default(cuid())
  url       String
  altText   String?
  isPrimary Boolean @default(false)
  sortOrder Int     @default(0)

  recipeId String
  recipe   Recipe @relation(fields: [recipeId], references: [id], onDelete: Cascade)

  @@index([recipeId])
}

// ==================== RÉGIMES ALIMENTAIRES ====================

model DietaryTag {
  id       String  @id @default(cuid())
  name     String  @unique // Végétarien, Végan, Sans gluten... 
  slug     String  @unique
  iconName String?

  recipes RecipeDietaryTag[]

  @@index([slug])
}

model RecipeDietaryTag {
  id String @id @default(cuid())

  recipeId String
  recipe   Recipe @relation(fields: [recipeId], references: [id], onDelete: Cascade)

  dietaryTagId String
  dietaryTag   DietaryTag @relation(fields: [dietaryTagId], references: [id], onDelete: Cascade)

  @@unique([recipeId, dietaryTagId])
  @@index([recipeId])
  @@index([dietaryTagId])
}

// ==================== AVIS & COMMENTAIRES ====================

model Rating {
  id        String   @id @default(cuid())
  score     Int // 1-5 étoiles
  createdAt DateTime @default(now())

  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  recipeId String
  recipe   Recipe @relation(fields: [recipeId], references: [id], onDelete: Cascade)

  @@unique([userId, recipeId])
  @@index([recipeId])
  @@index([userId])
}

model Comment {
  id        String   @id @default(cuid())
  content   String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  recipeId String
  recipe   Recipe @relation(fields: [recipeId], references: [id], onDelete: Cascade)

  parentId String?
  parent   Comment?  @relation("Replies", fields: [parentId], references: [id], onDelete: Cascade)
  replies  Comment[] @relation("Replies")

  @@index([recipeId])
  @@index([userId])
  @@index([parentId])
}

// ==================== FAVORIS ====================

model Favorite {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now())

  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  recipeId String
  recipe   Recipe @relation(fields: [recipeId], references: [id], onDelete: Cascade)

  @@unique([userId, recipeId])
  @@index([userId])
  @@index([recipeId])
}

// ==================== MESSAGERIE (Chat temps réel) ====================

model Conversation {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  participants ConversationParticipant[]
  messages     Message[]

  @@index([updatedAt])
}

model ConversationParticipant {
  id         String    @id @default(cuid())
  lastReadAt DateTime?
  joinedAt   DateTime  @default(now())

  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  conversationId String
  conversation   Conversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)

  @@unique([userId, conversationId])
  @@index([userId])
  @@index([conversationId])
}

model Message {
  id        String   @id @default(cuid())
  content   String
  createdAt DateTime @default(now())

  senderId String
  sender   User   @relation("SentMessages", fields: [senderId], references: [id], onDelete: Cascade)

  conversationId String
  conversation   Conversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)

  @@index([conversationId])
  @@index([senderId])
  @@index([createdAt])
}

// ==================== NOTIFICATIONS ====================

model Notification {
  id        String           @id @default(cuid())
  type      NotificationType
  title     String
  message   String
  data      Json?
  isRead    Boolean          @default(false)
  createdAt DateTime         @default(now())

  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, isRead])
  @@index([createdAt])
}

enum NotificationType {
  NEW_FOLLOWER
  NEW_FRIEND_REQUEST
  FRIEND_REQUEST_ACCEPTED
  NEW_COMMENT
  NEW_RATING
  NEW_MESSAGE
  RECIPE_FAVORITED
}
